'use strict';

var _toConsumableArray2 = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/helpers/toConsumableArray.js');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _index = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/regenerator/index.js');

var _index2 = _interopRequireDefault(_index);

var _asyncToGenerator2 = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/helpers/asyncToGenerator.js');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _typeof2 = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/helpers/typeof.js');

var _typeof3 = _interopRequireDefault(_typeof2);

var _powerAssertRecorder = function () { function PowerAssertRecorder() { this.captured = []; } PowerAssertRecorder.prototype._capt = function _capt(value, espath) { this.captured.push({ value: value, espath: espath }); return value; }; PowerAssertRecorder.prototype._expr = function _expr(value, source) { var capturedValues = this.captured; this.captured = []; return { powerAssertContext: { value: value, events: capturedValues }, source: source }; }; return PowerAssertRecorder; }();

var run = function () {
	var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee(inputPath, expectedPath, opts, t) {
		var _rec = new _powerAssertRecorder(),
		    _rec2 = new _powerAssertRecorder();

		var input, expected, processor, result;
		return _index2.default.wrap(function _callee$(_context) {
			while (1) {
				switch (_context.prev = _context.next) {
					case 0:
						_context.next = 2;
						return _fsExtra2.default.readFileAsync(inputPath, 'utf8');

					case 2:
						input = _context.sent;
						_context.next = 5;
						return _fsExtra2.default.readFileAsync(expectedPath, 'utf8');

					case 5:
						expected = _context.sent;
						processor = (0, _postcss2.default)([(0, _lib2.default)(opts)]);
						_context.next = 9;
						return processor.process(input, { from: inputPath });

					case 9:
						result = _context.sent;


						t.deepEqual(_rec._expr(_rec._capt(_rec._capt(result, 'arguments/0/object').css, 'arguments/0'), {
							content: 't.deepEqual(result.css, expected)',
							filepath: 'test/11-e2e.js',
							line: 16,
							async: true
						}), _rec2._expr(_rec2._capt(expected, 'arguments/1'), {
							content: 't.deepEqual(result.css, expected)',
							filepath: 'test/11-e2e.js',
							line: 16,
							async: true
						}));

					case 11:
					case 'end':
						return _context.stop();
				}
			}
		}, _callee, this);
	}));

	return function run(_x, _x2, _x3, _x4) {
		return _ref.apply(this, arguments);
	};
}();

var _ava = require('ava');

var _ava2 = _interopRequireDefault(_ava);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lib = require('../lib');

var _lib2 = _interopRequireDefault(_lib);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _avaThrowsHelper(fn, data) {
	try {
		return fn();
	} catch (e) {
		var type = typeof e === 'undefined' ? 'undefined' : (0, _typeof3.default)(e);

		if (e !== null && (type === "object" || type === "function")) {
			try {
				Object.defineProperty(e, "_avaThrowsHelperData", {
					value: data
				});
			} catch (e) {}
		}

		throw e;
	}
}

_bluebird2.default.promisifyAll(_fsExtra2.default);

(0, _ava2.default)('throws error', function () {
	var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee2(t) {
		var inputPath, opts, input, processor;
		return _index2.default.wrap(function _callee2$(_context2) {
			while (1) {
				switch (_context2.prev = _context2.next) {
					case 0:
						inputPath = './fixtures/error/style.css';
						opts = {
							stylesheetPath: './build/example-error/',
							spritePath: './build/example-error/'
						};
						_context2.next = 4;
						return _fsExtra2.default.readFileAsync(inputPath, 'utf8');

					case 4:
						input = _context2.sent;
						processor = (0, _postcss2.default)([(0, _lib2.default)(opts)]);


						t.throws(_avaThrowsHelper(function () {
							return processor.process(input, { from: inputPath });
						}, {
							line: 29,
							column: 10,
							source: 'processor.process(input, { from: inputPath })',
							filename: '/Users/zhangqian/Documents/flavia/postcss-assert/test/11-e2e.js'
						}));

					case 7:
					case 'end':
						return _context2.stop();
				}
			}
		}, _callee2, undefined);
	}));

	return function (_x5) {
		return _ref2.apply(this, arguments);
	};
}());

(0, _ava2.default)('basic', function () {
	var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee3(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee3$(_context3) {
			while (1) {
				switch (_context3.prev = _context3.next) {
					case 0:
						inputPath = './fixtures/basic/style.css';
						expectedPath = './expectations/basic/style.css';
						opts = {
							stylesheetPath: './build/basic/',
							spritePath: './build/basic/'
						};
						return _context3.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context3.stop();
				}
			}
		}, _callee3, undefined);
	}));

	return function (_x6) {
		return _ref3.apply(this, arguments);
	};
}());

(0, _ava2.default)('basic SVG', function () {
	var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee4(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee4$(_context4) {
			while (1) {
				switch (_context4.prev = _context4.next) {
					case 0:
						inputPath = './fixtures/svg-basic/style.css';
						expectedPath = './expectations/svg-basic/style.css';
						opts = {
							stylesheetPath: './build/svg-basic/',
							spritePath: './build/svg-basic/'
						};
						return _context4.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context4.stop();
				}
			}
		}, _callee4, undefined);
	}));

	return function (_x7) {
		return _ref4.apply(this, arguments);
	};
}());

(0, _ava2.default)('retina', function () {
	var _ref5 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee5(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee5$(_context5) {
			while (1) {
				switch (_context5.prev = _context5.next) {
					case 0:
						inputPath = './fixtures/retina/style.css';
						expectedPath = './expectations/retina/style.css';
						opts = {
							stylesheetPath: './build/retina/',
							spritePath: './build/retina/',
							retina: true
						};
						return _context5.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context5.stop();
				}
			}
		}, _callee5, undefined);
	}));

	return function (_x8) {
		return _ref5.apply(this, arguments);
	};
}());

(0, _ava2.default)('color', function () {
	var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee6(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee6$(_context6) {
			while (1) {
				switch (_context6.prev = _context6.next) {
					case 0:
						inputPath = './fixtures/color/style.css';
						expectedPath = './expectations/color/style.css';
						opts = {
							stylesheetPath: './build/color/',
							spritePath: './build/color/'
						};
						return _context6.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context6.stop();
				}
			}
		}, _callee6, undefined);
	}));

	return function (_x9) {
		return _ref6.apply(this, arguments);
	};
}());

(0, _ava2.default)('absolute path', function () {
	var _ref7 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee7(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee7$(_context7) {
			while (1) {
				switch (_context7.prev = _context7.next) {
					case 0:
						inputPath = './fixtures/absolute/css/style.css';
						expectedPath = './expectations/absolute/style.css';
						opts = {
							basePath: './fixtures/absolute/',
							stylesheetPath: './build/absolute/',
							spritePath: './build/absolute/'
						};
						return _context7.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context7.stop();
				}
			}
		}, _callee7, undefined);
	}));

	return function (_x10) {
		return _ref7.apply(this, arguments);
	};
}());

(0, _ava2.default)('relative path', function () {
	var _ref8 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee8(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee8$(_context8) {
			while (1) {
				switch (_context8.prev = _context8.next) {
					case 0:
						inputPath = './fixtures/relative/style.css';
						expectedPath = './expectations/relative/style.css';
						opts = {
							spritePath: './build/relative/'
						};
						return _context8.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context8.stop();
				}
			}
		}, _callee8, undefined);
	}));

	return function (_x11) {
		return _ref8.apply(this, arguments);
	};
}());

(0, _ava2.default)('filter by', function () {
	var _ref9 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee9(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee9$(_context9) {
			while (1) {
				switch (_context9.prev = _context9.next) {
					case 0:
						inputPath = './fixtures/filter-by/style.css';
						expectedPath = './expectations/filter-by/style.css';
						opts = {
							stylesheetPath: './build/filter-by/',
							spritePath: './build/filter-by/',
							filterBy: function filterBy(image) {
								if (image.url.indexOf('square') === -1) {
									return _bluebird2.default.reject();
								}

								return _bluebird2.default.resolve();
							}
						};
						return _context9.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context9.stop();
				}
			}
		}, _callee9, undefined);
	}));

	return function (_x12) {
		return _ref9.apply(this, arguments);
	};
}());

(0, _ava2.default)('group by', function () {
	var _ref10 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee10(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee10$(_context10) {
			while (1) {
				switch (_context10.prev = _context10.next) {
					case 0:
						inputPath = './fixtures/group-by/style.css';
						expectedPath = './expectations/group-by/style.css';
						opts = {
							stylesheetPath: './build/group-by/',
							spritePath: './build/group-by/',
							groupBy: function groupBy(image) {
								if (image.url.indexOf('square') === -1 && image.url.indexOf('circle') === -1) {
									return _bluebird2.default.reject();
								}

								return _bluebird2.default.resolve('shapes');
							}
						};
						return _context10.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context10.stop();
				}
			}
		}, _callee10, undefined);
	}));

	return function (_x13) {
		return _ref10.apply(this, arguments);
	};
}());

(0, _ava2.default)('hooks', function () {
	var _ref11 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee11(t) {
		var inputPath, expectedPath, opts;
		return _index2.default.wrap(function _callee11$(_context11) {
			while (1) {
				switch (_context11.prev = _context11.next) {
					case 0:
						inputPath = './fixtures/hooks/style.css';
						expectedPath = './expectations/hooks/style.css';
						opts = {
							stylesheetPath: './build/hooks/',
							spritePath: './build/hooks/',
							hooks: {
								onSaveSpritesheet: function onSaveSpritesheet(opts, groups) {
									return _path2.default.join(opts.spritePath, ['shapes'].concat((0, _toConsumableArray3.default)(groups), ['png']).join('.'));
								},
								onUpdateRule: function onUpdateRule(rule, token, image) {
									rule.insertAfter(token, _postcss2.default.decl({
										prop: 'background-image',
										value: 'url(' + image.spriteUrl + ')'
									}));
								}
							}
						};
						return _context11.abrupt('return', run(inputPath, expectedPath, opts, t));

					case 4:
					case 'end':
						return _context11.stop();
				}
			}
		}, _callee11, undefined);
	}));

	return function (_x14) {
		return _ref11.apply(this, arguments);
	};
}());
//# sourceMappingURL=../node_modules/.cache/ava/a6b6dfed9336d7b6f0fde73ca3431220.js.map
'use strict';

var _index = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/regenerator/index.js');

var _index2 = _interopRequireDefault(_index);

var _slicedToArray2 = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/helpers/slicedToArray.js');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _asyncToGenerator2 = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/helpers/asyncToGenerator.js');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _typeof2 = require('/Users/zhangqian/Documents/flavia/postcss-assert/node_modules/babel-runtime/helpers/typeof.js');

var _typeof3 = _interopRequireDefault(_typeof2);

var _powerAssertRecorder = function () { function PowerAssertRecorder() { this.captured = []; } PowerAssertRecorder.prototype._capt = function _capt(value, espath) { this.captured.push({ value: value, espath: espath }); return value; }; PowerAssertRecorder.prototype._expr = function _expr(value, source) { var capturedValues = this.captured; this.captured = []; return { powerAssertContext: { value: value, events: capturedValues }, source: source }; }; return PowerAssertRecorder; }();

var _ava = require('ava');

var _ava2 = _interopRequireDefault(_ava);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _core = require('../lib/core');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _avaThrowsHelper(fn, data) {
	try {
		return fn();
	} catch (e) {
		var type = typeof e === 'undefined' ? 'undefined' : (0, _typeof3.default)(e);

		if (e !== null && (type === "object" || type === "function")) {
			try {
				Object.defineProperty(e, "_avaThrowsHelperData", {
					value: data
				});
			} catch (e) {}
		}

		throw e;
	}
}

var readFileAsync = _bluebird2.default.promisify(_fsExtra2.default.readFile);

_ava2.default.beforeEach(function (t) {
	t.context.opts = _lodash2.default.merge({
		logger: function logger() {}
	}, _core.defaults);
});

(0, _ava2.default)('should save spritesheets', function () {
	var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee(t) {
		var _rec = new _powerAssertRecorder(),
		    _rec2 = new _powerAssertRecorder();

		var cssContents, ast, images, spritesheets, opts, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7;

		return _index2.default.wrap(function _callee$(_context) {
			while (1) {
				switch (_context.prev = _context.next) {
					case 0:
						_context.next = 2;
						return readFileAsync('./fixtures/basic/style.css');

					case 2:
						cssContents = _context.sent;
						ast = _postcss2.default.parse(cssContents, { from: './fixtures/basic/style.css' });
						images = void 0, spritesheets = void 0, opts = void 0;


						t.context.opts.spritePath = './build/basic';

						_context.next = 8;
						return (0, _core.extractImages)(ast, t.context.opts);

					case 8:
						_ref2 = _context.sent;
						_ref3 = (0, _slicedToArray3.default)(_ref2, 2);
						opts = _ref3[0];
						images = _ref3[1];
						_context.next = 14;
						return (0, _core.runSpritesmith)(t.context.opts, images);

					case 14:
						_ref4 = _context.sent;
						_ref5 = (0, _slicedToArray3.default)(_ref4, 3);
						opts = _ref5[0];
						images = _ref5[1];
						spritesheets = _ref5[2];
						_context.next = 21;
						return (0, _core.saveSpritesheets)(t.context.opts, images, spritesheets);

					case 21:
						_ref6 = _context.sent;
						_ref7 = (0, _slicedToArray3.default)(_ref6, 3);
						opts = _ref7[0];
						images = _ref7[1];
						spritesheets = _ref7[2];


						t.deepEqual(_rec._expr(_rec._capt(_rec._capt(_rec._capt(spritesheets, 'arguments/0/object/object')[0], 'arguments/0/object').path, 'arguments/0'), {
							content: 't.deepEqual(spritesheets[0].path, \'build/basic/sprite.png\')',
							filepath: 'test/08-save-spritesheets.js',
							line: 33,
							async: true
						}), 'build/basic/sprite.png');
						t.truthy(_rec2._expr(_rec2._capt(_rec2._capt(_fsExtra2.default, 'arguments/0/callee/object').statAsync('./build/basic/sprite.png'), 'arguments/0'), {
							content: 't.truthy(fs.statAsync(\'./build/basic/sprite.png\'))',
							filepath: 'test/08-save-spritesheets.js',
							line: 34,
							async: true
						}));

					case 28:
					case 'end':
						return _context.stop();
				}
			}
		}, _callee, undefined);
	}));

	return function (_x) {
		return _ref.apply(this, arguments);
	};
}());

(0, _ava2.default)('should save SVG spritesheets', function () {
	var _ref8 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee2(t) {
		var _rec3 = new _powerAssertRecorder(),
		    _rec4 = new _powerAssertRecorder();

		var cssContents, ast, images, spritesheets, opts, _ref9, _ref10, _ref11, _ref12, _ref13, _ref14, _ref15, _ref16;

		return _index2.default.wrap(function _callee2$(_context2) {
			while (1) {
				switch (_context2.prev = _context2.next) {
					case 0:
						_context2.next = 2;
						return readFileAsync('./fixtures/svg-basic/style.css');

					case 2:
						cssContents = _context2.sent;
						ast = _postcss2.default.parse(cssContents, { from: './fixtures/svg-basic/style.css' });
						images = void 0, spritesheets = void 0, opts = void 0;


						t.context.opts.spritePath = './build/svg-basic';

						(0, _core.prepareGroupBy)(t.context.opts);
						_context2.next = 9;
						return (0, _core.extractImages)(ast, t.context.opts);

					case 9:
						_ref9 = _context2.sent;
						_ref10 = (0, _slicedToArray3.default)(_ref9, 2);
						opts = _ref10[0];
						images = _ref10[1];
						_context2.next = 15;
						return (0, _core.applyGroupBy)(t.context.opts, images);

					case 15:
						_ref11 = _context2.sent;
						_ref12 = (0, _slicedToArray3.default)(_ref11, 2);
						opts = _ref12[0];
						images = _ref12[1];
						_context2.next = 21;
						return (0, _core.runSpritesmith)(t.context.opts, images);

					case 21:
						_ref13 = _context2.sent;
						_ref14 = (0, _slicedToArray3.default)(_ref13, 3);
						opts = _ref14[0];
						images = _ref14[1];
						spritesheets = _ref14[2];
						_context2.next = 28;
						return (0, _core.saveSpritesheets)(t.context.opts, images, spritesheets);

					case 28:
						_ref15 = _context2.sent;
						_ref16 = (0, _slicedToArray3.default)(_ref15, 3);
						opts = _ref16[0];
						images = _ref16[1];
						spritesheets = _ref16[2];


						t.deepEqual(_rec3._expr(_rec3._capt(_rec3._capt(_rec3._capt(spritesheets, 'arguments/0/object/object')[0], 'arguments/0/object').path, 'arguments/0'), {
							content: 't.deepEqual(spritesheets[0].path, \'build/svg-basic/sprite.svg\')',
							filepath: 'test/08-save-spritesheets.js',
							line: 50,
							async: true
						}), 'build/svg-basic/sprite.svg');
						t.truthy(_rec4._expr(_rec4._capt(_rec4._capt(_fsExtra2.default, 'arguments/0/callee/object').statAsync('./build/svg-basic/sprite.svg'), 'arguments/0'), {
							content: 't.truthy(fs.statAsync(\'./build/svg-basic/sprite.svg\'))',
							filepath: 'test/08-save-spritesheets.js',
							line: 51,
							async: true
						}));

					case 35:
					case 'end':
						return _context2.stop();
				}
			}
		}, _callee2, undefined);
	}));

	return function (_x2) {
		return _ref8.apply(this, arguments);
	};
}());

(0, _ava2.default)('should save spritesheets by groups', function () {
	var _ref17 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee3(t) {
		var _rec5 = new _powerAssertRecorder(),
		    _rec6 = new _powerAssertRecorder(),
		    _rec7 = new _powerAssertRecorder(),
		    _rec8 = new _powerAssertRecorder();

		var cssContents, ast, images, spritesheets, opts, _ref18, _ref19, _ref20, _ref21, _ref22, _ref23, _ref24, _ref25;

		return _index2.default.wrap(function _callee3$(_context3) {
			while (1) {
				switch (_context3.prev = _context3.next) {
					case 0:
						_context3.next = 2;
						return readFileAsync('./fixtures/retina/style.css');

					case 2:
						cssContents = _context3.sent;
						ast = _postcss2.default.parse(cssContents, { from: './fixtures/retina/style.css' });
						images = void 0, spritesheets = void 0, opts = void 0;


						t.context.opts.spritePath = './build/retina';
						t.context.opts.retina = true;

						(0, _core.prepareGroupBy)(t.context.opts);

						_context3.next = 10;
						return (0, _core.extractImages)(ast, t.context.opts);

					case 10:
						_ref18 = _context3.sent;
						_ref19 = (0, _slicedToArray3.default)(_ref18, 2);
						opts = _ref19[0];
						images = _ref19[1];
						_context3.next = 16;
						return (0, _core.applyGroupBy)(t.context.opts, images);

					case 16:
						_ref20 = _context3.sent;
						_ref21 = (0, _slicedToArray3.default)(_ref20, 2);
						opts = _ref21[0];
						images = _ref21[1];
						_context3.next = 22;
						return (0, _core.runSpritesmith)(t.context.opts, images);

					case 22:
						_ref22 = _context3.sent;
						_ref23 = (0, _slicedToArray3.default)(_ref22, 3);
						opts = _ref23[0];
						images = _ref23[1];
						spritesheets = _ref23[2];
						_context3.next = 29;
						return (0, _core.saveSpritesheets)(t.context.opts, images, spritesheets);

					case 29:
						_ref24 = _context3.sent;
						_ref25 = (0, _slicedToArray3.default)(_ref24, 3);
						opts = _ref25[0];
						images = _ref25[1];
						spritesheets = _ref25[2];


						t.deepEqual(_rec5._expr(_rec5._capt(_rec5._capt(_rec5._capt(spritesheets, 'arguments/0/object/object')[0], 'arguments/0/object').path, 'arguments/0'), {
							content: 't.deepEqual(spritesheets[0].path, \'build/retina/sprite.png\')',
							filepath: 'test/08-save-spritesheets.js',
							line: 69,
							async: true
						}), 'build/retina/sprite.png');
						t.deepEqual(_rec6._expr(_rec6._capt(_rec6._capt(_rec6._capt(spritesheets, 'arguments/0/object/object')[1], 'arguments/0/object').path, 'arguments/0'), {
							content: 't.deepEqual(spritesheets[1].path, \'build/retina/sprite.@2x.png\')',
							filepath: 'test/08-save-spritesheets.js',
							line: 70,
							async: true
						}), 'build/retina/sprite.@2x.png');
						t.truthy(_rec7._expr(_rec7._capt(_rec7._capt(_fsExtra2.default, 'arguments/0/callee/object').statAsync('./build/retina/sprite.png'), 'arguments/0'), {
							content: 't.truthy(fs.statAsync(\'./build/retina/sprite.png\'))',
							filepath: 'test/08-save-spritesheets.js',
							line: 71,
							async: true
						}));
						t.truthy(_rec8._expr(_rec8._capt(_rec8._capt(_fsExtra2.default, 'arguments/0/callee/object').statAsync('./build/retina/sprite.@2x.png'), 'arguments/0'), {
							content: 't.truthy(fs.statAsync(\'./build/retina/sprite.@2x.png\'))',
							filepath: 'test/08-save-spritesheets.js',
							line: 72,
							async: true
						}));

					case 38:
					case 'end':
						return _context3.stop();
				}
			}
		}, _callee3, undefined);
	}));

	return function (_x3) {
		return _ref17.apply(this, arguments);
	};
}());

(0, _ava2.default)('should use path provided by book', function () {
	var _ref26 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee4(t) {
		var _rec9 = new _powerAssertRecorder(),
		    _rec10 = new _powerAssertRecorder();

		var cssContents, ast, images, spritesheets, opts, _ref27, _ref28, _ref29, _ref30, _ref31, _ref32;

		return _index2.default.wrap(function _callee4$(_context4) {
			while (1) {
				switch (_context4.prev = _context4.next) {
					case 0:
						_context4.next = 2;
						return readFileAsync('./fixtures/basic/style.css');

					case 2:
						cssContents = _context4.sent;
						ast = _postcss2.default.parse(cssContents, { from: './fixtures/basic/style.css' });
						images = void 0, spritesheets = void 0, opts = void 0;


						t.context.opts.spritePath = './build/on-save-hook/';
						t.context.opts.hooks.onSaveSpritesheet = function (pluginOpts, spritesheetGroups) {
							return _path2.default.join(pluginOpts.spritePath, 'custom-name.png');
						};

						_context4.next = 9;
						return (0, _core.extractImages)(ast, t.context.opts);

					case 9:
						_ref27 = _context4.sent;
						_ref28 = (0, _slicedToArray3.default)(_ref27, 2);
						opts = _ref28[0];
						images = _ref28[1];
						_context4.next = 15;
						return (0, _core.runSpritesmith)(t.context.opts, images);

					case 15:
						_ref29 = _context4.sent;
						_ref30 = (0, _slicedToArray3.default)(_ref29, 3);
						opts = _ref30[0];
						images = _ref30[1];
						spritesheets = _ref30[2];
						_context4.next = 22;
						return (0, _core.saveSpritesheets)(t.context.opts, images, spritesheets);

					case 22:
						_ref31 = _context4.sent;
						_ref32 = (0, _slicedToArray3.default)(_ref31, 3);
						opts = _ref32[0];
						images = _ref32[1];
						spritesheets = _ref32[2];


						t.deepEqual(_rec9._expr(_rec9._capt(_rec9._capt(_rec9._capt(spritesheets, 'arguments/0/object/object')[0], 'arguments/0/object').path, 'arguments/0'), {
							content: 't.deepEqual(spritesheets[0].path, \'build/on-save-hook/custom-name.png\')',
							filepath: 'test/08-save-spritesheets.js',
							line: 89,
							async: true
						}), 'build/on-save-hook/custom-name.png');
						t.truthy(_rec10._expr(_rec10._capt(_rec10._capt(_fsExtra2.default, 'arguments/0/callee/object').statAsync('./build/on-save-hook/custom-name.png'), 'arguments/0'), {
							content: 't.truthy(fs.statAsync(\'./build/on-save-hook/custom-name.png\'))',
							filepath: 'test/08-save-spritesheets.js',
							line: 90,
							async: true
						}));

					case 29:
					case 'end':
						return _context4.stop();
				}
			}
		}, _callee4, undefined);
	}));

	return function (_x4) {
		return _ref26.apply(this, arguments);
	};
}());

(0, _ava2.default)('should throw error if path is empty', function () {
	var _ref33 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee5(t) {
		var cssContents, ast, images, spritesheets, opts, _ref34, _ref35, _ref36, _ref37;

		return _index2.default.wrap(function _callee5$(_context5) {
			while (1) {
				switch (_context5.prev = _context5.next) {
					case 0:
						_context5.next = 2;
						return readFileAsync('./fixtures/basic/style.css');

					case 2:
						cssContents = _context5.sent;
						ast = _postcss2.default.parse(cssContents, { from: './fixtures/basic/style.css' });
						images = void 0, spritesheets = void 0, opts = void 0;


						t.context.opts.spritePath = './build/on-save-hook/';
						t.context.opts.hooks.onSaveSpritesheet = function (pluginOpts, spritesheetGroups) {
							return '';
						};

						_context5.next = 9;
						return (0, _core.extractImages)(ast, t.context.opts);

					case 9:
						_ref34 = _context5.sent;
						_ref35 = (0, _slicedToArray3.default)(_ref34, 2);
						opts = _ref35[0];
						images = _ref35[1];
						_context5.next = 15;
						return (0, _core.runSpritesmith)(t.context.opts, images);

					case 15:
						_ref36 = _context5.sent;
						_ref37 = (0, _slicedToArray3.default)(_ref36, 3);
						opts = _ref37[0];
						images = _ref37[1];
						spritesheets = _ref37[2];


						t.throws(_avaThrowsHelper(function () {
							return (0, _core.saveSpritesheets)(t.context.opts, images, spritesheets);
						}, {
							line: 106,
							column: 10,
							source: 'saveSpritesheets(t.context.opts, images, spritesheets)',
							filename: '/Users/zhangqian/Documents/flavia/postcss-assert/test/08-save-spritesheets.js'
						}));

					case 21:
					case 'end':
						return _context5.stop();
				}
			}
		}, _callee5, undefined);
	}));

	return function (_x5) {
		return _ref33.apply(this, arguments);
	};
}());

(0, _ava2.default)('should use Promise result provided by book', function () {
	var _ref38 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_index2.default.mark(function _callee6(t) {
		var _rec11 = new _powerAssertRecorder(),
		    _rec12 = new _powerAssertRecorder();

		var cssContents, ast, images, spritesheets, opts, _ref39, _ref40, _ref41, _ref42, _ref43, _ref44;

		return _index2.default.wrap(function _callee6$(_context6) {
			while (1) {
				switch (_context6.prev = _context6.next) {
					case 0:
						_context6.next = 2;
						return readFileAsync('./fixtures/basic/style.css');

					case 2:
						cssContents = _context6.sent;
						ast = _postcss2.default.parse(cssContents, { from: './fixtures/basic/style.css' });
						images = void 0, spritesheets = void 0, opts = void 0;


						t.context.opts.spritePath = './build/on-save-hook/';
						t.context.opts.hooks.onSaveSpritesheet = function (pluginOpts, spritesheetGroups) {
							return new _bluebird2.default(function (resolve) {
								return setTimeout(function () {
									return resolve(_bluebird2.default.resolve(_path2.default.join(pluginOpts.spritePath, 'custom-name.png')));
								}, 0);
							});
						};

						_context6.next = 9;
						return (0, _core.extractImages)(ast, t.context.opts);

					case 9:
						_ref39 = _context6.sent;
						_ref40 = (0, _slicedToArray3.default)(_ref39, 2);
						opts = _ref40[0];
						images = _ref40[1];
						_context6.next = 15;
						return (0, _core.runSpritesmith)(t.context.opts, images);

					case 15:
						_ref41 = _context6.sent;
						_ref42 = (0, _slicedToArray3.default)(_ref41, 3);
						opts = _ref42[0];
						images = _ref42[1];
						spritesheets = _ref42[2];
						_context6.next = 22;
						return (0, _core.saveSpritesheets)(t.context.opts, images, spritesheets);

					case 22:
						_ref43 = _context6.sent;
						_ref44 = (0, _slicedToArray3.default)(_ref43, 3);
						opts = _ref44[0];
						images = _ref44[1];
						spritesheets = _ref44[2];


						t.deepEqual(_rec11._expr(_rec11._capt(_rec11._capt(_rec11._capt(spritesheets, 'arguments/0/object/object')[0], 'arguments/0/object').path, 'arguments/0'), {
							content: 't.deepEqual(spritesheets[0].path, \'build/on-save-hook/custom-name.png\')',
							filepath: 'test/08-save-spritesheets.js',
							line: 123,
							async: true
						}), 'build/on-save-hook/custom-name.png');
						t.truthy(_rec12._expr(_rec12._capt(_rec12._capt(_fsExtra2.default, 'arguments/0/callee/object').statAsync('./build/on-save-hook/custom-name.png'), 'arguments/0'), {
							content: 't.truthy(fs.statAsync(\'./build/on-save-hook/custom-name.png\'))',
							filepath: 'test/08-save-spritesheets.js',
							line: 124,
							async: true
						}));

					case 29:
					case 'end':
						return _context6.stop();
				}
			}
		}, _callee6, undefined);
	}));

	return function (_x6) {
		return _ref38.apply(this, arguments);
	};
}());
//# sourceMappingURL=../node_modules/.cache/ava/d54b0de5db93053f060d9afcaad3ead6.js.map